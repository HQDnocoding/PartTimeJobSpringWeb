<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title>Chi tiết công việc</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <th:block th:replace="~{base :: bootstrap}"></th:block>
    <style>
        .job-detail-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .job-detail-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .job-detail-card .card-body {
            padding: 2rem;
        }
        .job-detail-card p {
            margin-bottom: 1rem;
            font-size: 1rem;
            line-height: 1.6;
        }
        .job-detail-card strong {
            display: inline-block;
            width: 150px;
            font-weight: 600;
            color: #555;
        }
        .card-header {
            background-color: #007bff;
            color: white;
            text-align: center;
            padding: 1rem;
        }
        .card-footer {
            display: flex !important;
            justify-content: flex-end !important;
            gap: 0.5rem !important;
            padding: 1rem;
        }
        .form-container {
            margin-top: 2rem;
        }
        .form-label {
            font-weight: 500;
        }
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .selected-company {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .btn {
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .edit-mode .selected-company {
            display: none;
        }
    </style>
</head>
<body>
    <div th:replace="~{base :: header}"></div>
    <main class="container my-4 job-detail-container">
        <div class="card">
            <div class="card-header">
                <h1 class="mb-0">Chi tiết công việc</h1>
            </div>
            <div th:if="${successMessage}" class="alert alert-success" role="alert">
                <span th:text="${successMessage}"></span>
            </div>
            <div th:if="${errorMessage}" class="alert alert-danger" role="alert">
                <span th:text="${errorMessage}"></span>
            </div>
            <div th:if="${job == null}">
                <div class="card-body">
                    <div class="alert alert-danger" role="alert">
                        Công việc không tồn tại hoặc chưa được phê duyệt.
                    </div>
                    <a href="/jobs" class="btn btn-secondary">Quay lại danh sách</a>
                </div>
            </div>
            <div th:if="${job != null}" class="card job-detail-card">
                <div class="card-body">
                    <p class="selected-company" th:text="${job.companyId?.name} ?: 'Chưa có công ty'">Công ty: [Tên công ty]</p>
                    <p><strong>Tên công việc:</strong> <span th:text="${job.jobName} ?: '-'"></span></p>
                    <p><strong>Lương:</strong> <span th:text="${job.salaryMin != null and job.salaryMax != null} ? ${job.salaryMin} + ' - ' + ${job.salaryMax} + ' VNĐ' : '-'"></span></p>
                    <p><strong>Địa chỉ:</strong> <span th:text="${job.fullAddress != null and job.district != null and job.city != null} ? ${job.fullAddress} + ', ' + ${job.district} + ', ' + ${job.city} : '-'"></span></p>
                    <p><strong>Ngành nghề:</strong> <span th:text="${job.majorJobCollection != null and !#lists.isEmpty(job.majorJobCollection)} ? ${#strings.listJoin(job.majorJobCollection.![majorId.name], ', ')} : '-'"></span></p>
                    <p><strong>Thời gian làm việc:</strong> <span th:text="${job.dayJobCollection != null and !#lists.isEmpty(job.dayJobCollection)} ? ${#strings.listJoin(job.dayJobCollection.![dayId.name], ', ')} : '-'"></span></p>
                    <p><strong>Tuổi từ:</strong> <span th:text="${job.ageFrom != null} ? ${job.ageFrom} : '-'"></span></p>
                    <p><strong>Tuổi đến:</strong> <span th:text="${job.ageTo != null} ? ${job.ageTo} : '-'"></span></p>
                    <p><strong>Kinh nghiệm:</strong> <span th:text="${job.experienceRequired != null} ? ${job.experienceRequired} + ' năm' : '-'"></span></p>
                    <p><strong>Mô tả:</strong> <span th:utext="${job.description != null} ? ${job.description} : '-'"></span></p>
                    <p><strong>Yêu cầu:</strong> <span th:utext="${job.jobRequired != null} ? ${job.jobRequired} : '-'"></span></p>
                    <p><strong>Ngày đăng:</strong> <span th:text="${job.postedDate != null} ? ${#dates.format(job.postedDate, 'dd/MM/yyyy HH:mm:ss')} : '-'"></span></p>
                    <p><strong>Trạng thái:</strong> <span th:text="${job.status != null} ? ${job.status} : '-'"></span></p>
                    <p><strong>Trạng thái hoạt động:</strong> <span th:text="${job.isActive != null} ? (${job.isActive} ? 'Hoạt động' : 'Không hoạt động') : '-'"></span></p>

                    <div sec:authorize="hasRole('ROLE_ADMIN')" class="form-container">
                        <div class="card-header bg-primary text-white">
                            <h3 class="mb-0">Chỉnh sửa công việc</h3>
                        </div>
                        <form id="jobForm" th:action="@{'/jobs/' + ${job.id} + '/update'}" method="post">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="jobName" class="form-label">Tên công việc *</label>
                                    <input type="text" id="jobName" name="jobName" th:value="${job.jobName}" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="companyId" class="form-label">Công ty *</label>
                                    <select id="companyId" name="companyId" class="form-select" required>
                                        <option value="" disabled>Chọn công ty</option>
                                        <option th:each="company : ${companies}" 
                                                th:value="${company.id}" 
                                                th:text="${company.name}" 
                                                th:attr="data-full-address=${company.fullAddress},data-city=${company.city},data-district=${company.district}"
                                                th:selected="${company.id == job.companyId?.id}"></option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="fullAddress" class="form-label">Địa chỉ</label>
                                    <input type="text" id="fullAddress" name="fullAddress" th:value="${job.fullAddress}" class="form-control" readonly>
                                    <input type="hidden" name="fullAddress" th:value="${job.fullAddress}" />
                                </div>
                                <div class="col-md-6">
                                    <label for="city" class="form-label">Thành phố</label>
                                    <input type="text" id="city" name="city" th:value="${job.city}" class="form-control" readonly>
                                    <input type="hidden" name="city" th:value="${job.city}" />
                                </div>
                                <div class="col-md-6">
                                    <label for="district" class="form-label">Quận/Huyện</label>
                                    <input type="text" id="district" name="district" th:value="${job.district}" class="form-control" readonly>
                                    <input type="hidden" name="district" th:value="${job.district}" />
                                </div>
                                <div class="col-md-6">
                                    <label for="salaryMin" class="form-label">Lương tối thiểu (VNĐ) *</label>
                                    <input type="number" id="salaryMin" name="salaryMin" th:value="${job.salaryMin}" class="form-control" min="0" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="salaryMax" class="form-label">Lương tối đa (VNĐ) *</label>
                                    <input type="number" id="salaryMax" name="salaryMax" th:value="${job.salaryMax}" class="form-control" min="0" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="majorId" class="form-label">Ngành nghề *</label>
                                    <select id="majorId" name="majorId" class="form-select" required>
                                        <option value="" disabled>Chọn ngành nghề</option>
                                        <option th:each="major : ${majors}" 
                                                th:value="${major.id}" 
                                                th:text="${major.name}" 
                                                th:selected="${job.majorJobCollection != null and !#lists.isEmpty(job.majorJobCollection) and job.majorJobCollection.![majorId.id].contains(major.id)}"></option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="ageFrom" class="form-label">Tuổi tối thiểu</label>
                                    <input type="number" id="ageFrom" name="ageFrom" th:value="${job.ageFrom}" class="form-control" min="0">
                                </div>
                                <div class="col-md-6">
                                    <label for="ageTo" class="form-label">Tuổi tối đa</label>
                                    <input type="number" id="ageTo" name="ageTo" th:value="${job.ageTo}" class="form-control" min="0">
                                </div>
                                <div class="col-md-6">
                                    <label for="experienceRequired" class="form-label">Kinh nghiệm yêu cầu (năm)</label>
                                    <input type="number" id="experienceRequired" name="experienceRequired" th:value="${job.experienceRequired}" class="form-control" min="0">
                                </div>
                                <div class="col-12">
                                    <label for="description" class="form-label">Mô tả công việc *</label>
                                    <textarea id="description" name="description" th:text="${job.description}" class="form-control" rows="5" required></textarea>
                                </div>
                                <div class="col-12">
                                    <label for="jobRequired" class="form-label">Yêu cầu công việc *</label>
                                    <textarea id="jobRequired" name="jobRequired" th:text="${job.jobRequired}" class="form-control" rows="5" required></textarea>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Thời gian làm việc * (Chọn ít nhất một)</label>
                                    <div class="checkbox-group">
                                        <div th:each="day : ${days}">
                                            <input type="checkbox" 
                                                   name="dayIds" 
                                                   th:value="${day.id}" 
                                                   th:id="'dayId-' + ${day.id}" 
                                                   th:checked="${job.dayJobCollection != null and !#lists.isEmpty(job.dayJobCollection) and job.dayJobCollection.![dayId.id].contains(day.id)}">
                                            <label th:for="'dayId-' + ${day.id}" th:text="${day.name}"></label>
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" name="id" th:value="${job.id}" />
                                <input type="hidden" name="status" th:value="${job.status}" />
                                <input type="hidden" name="isActive" th:value="${job.isActive}" />
                            </div>
                        </form>
                    </div>
                </div>
                <div sec:authorize="hasRole('ROLE_ADMIN')" class="card-footer d-flex justify-content-end gap-2">
                    <button type="submit" form="jobForm" class="btn btn-primary">Lưu</button>
                    <a th:href="@{'/jobs/delete?jobIds=' + ${job.id}}" class="btn btn-danger" onclick="return confirm('Bạn có chắc muốn xóa công việc này?')">Xóa</a>
                    <a th:href="@{/jobs}" class="btn btn-secondary">Quay lại danh sách</a>
                </div>
            </div>
        </div>
    </main>
    <div th:replace="~{base :: footer}"></div>

    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function () {
            const companySelect = document.getElementById('companyId');
            const fullAddressInput = document.getElementById('fullAddress');
            const cityInput = document.getElementById('city');
            const districtInput = document.getElementById('district');

            function updateCompanyAddress() {
                if (companySelect && fullAddressInput && cityInput && districtInput) {
                    const selectedOption = companySelect.options[companySelect.selectedIndex];
                    if (selectedOption && selectedOption.value) {
                        fullAddressInput.value = selectedOption.getAttribute('data-full-address') || '';
                        cityInput.value = selectedOption.getAttribute('data-city') || '';
                        districtInput.value = selectedOption.getAttribute('data-district') || '';
                    } else {
                        fullAddressInput.value = '';
                        cityInput.value = '';
                        districtInput.value = '';
                    }
                }
            }

            if (companySelect) {
                companySelect.addEventListener('change', updateCompanyAddress);
                updateCompanyAddress();
            }
        });
    </script>
</body>
</html>